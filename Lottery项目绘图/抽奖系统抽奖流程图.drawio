<mxfile host="app.diagrams.net" modified="2023-08-21T14:02:30.573Z" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36 Edg/115.0.1901.203" etag="GQE-v0HWv0v-i8fosF6H" version="21.6.7" type="github">
  <diagram id="d3ml1dbwhwLsJx4-uYSs" name="Page-1">
    <mxGraphModel dx="1149" dy="637" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-70" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1060" y="110" width="470" height="780" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-42" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1560" y="430" width="510" height="650" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=11;fontColor=#FF0000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-2" target="kdpg4Kdw_f9-5tc5uiKG-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-2" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace ; font-size: 11px&quot;&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0) ; font-size: 11px&quot;&gt;DrawReq drawReq &lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;= &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 51 , 179) ; font-size: 11px&quot;&gt;new &lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;DrawReq();&lt;span style=&quot;font-size: 11px&quot;&gt;&lt;br style=&quot;font-size: 11px&quot;&gt;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0) ; font-size: 11px&quot;&gt;drawReq&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;.setuId(&lt;/font&gt;&lt;span style=&quot;color: rgb(6 , 125 , 23) ; font-size: 11px&quot;&gt;&quot;xiaofuge&quot;&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;);&lt;span style=&quot;font-size: 11px&quot;&gt;&lt;br style=&quot;font-size: 11px&quot;&gt;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0) ; font-size: 11px&quot;&gt;drawReq&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;.setActivityId(&lt;/font&gt;&lt;span style=&quot;color: rgb(23 , 80 , 235) ; font-size: 11px&quot;&gt;100001L&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;);&lt;span style=&quot;font-size: 11px&quot;&gt;&lt;br style=&quot;font-size: 11px&quot;&gt;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0) ; font-size: 11px&quot;&gt;DrawRes drawRes &lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;= &lt;/font&gt;&lt;span style=&quot;color: rgb(135 , 16 , 148) ; font-size: 11px&quot;&gt;lotteryActivityBooth&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;.&lt;/font&gt;&lt;b&gt;&lt;font color=&quot;#ff0000&quot;&gt;doDraw&lt;/font&gt;&lt;/b&gt;&lt;font color=&quot;#080808&quot;&gt;(&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0) ; font-size: 11px&quot;&gt;drawReq&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;);&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=11;align=left;" parent="1" vertex="1">
          <mxGeometry x="175" y="30" width="360" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-3" value="&lt;pre style=&quot;font-size: 12px ; background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;span style=&quot;color: rgb(135 , 16 , 148)&quot;&gt;执行抽奖：activityProcess&lt;/span&gt;.doDrawProcess(&lt;/pre&gt;&lt;pre style=&quot;font-size: 12px ; background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;span style=&quot;color: rgb(0 , 51 , 179)&quot;&gt;new &lt;/span&gt;DrawProcessReq(drawReq.getuId(), drawReq.getActivityId()));&lt;/pre&gt;" style="whiteSpace=wrap;html=1;fontSize=11;align=left;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="150" y="160" width="410" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-8" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;fontSize=12;fontColor=#FF0000;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="540" y="189.76" as="sourcePoint" />
            <mxPoint x="610" y="189.76" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-10" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;span style=&quot;color: #871094&quot;&gt;（1）领取活动：activityPartake&lt;/span&gt;.doPartake(&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;span style=&quot;color: #0033b3&quot;&gt;new &lt;/span&gt;PartakeReq(req.getuId(), req.getActivityId()));&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="610" y="160" width="410" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-11" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;fontSize=12;fontColor=#FF0000;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1000" y="189.5" as="sourcePoint" />
            <mxPoint x="1070" y="189.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#000000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-12" target="kdpg4Kdw_f9-5tc5uiKG-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-25" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=12;fontColor=#000000;dashed=1;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-12" target="kdpg4Kdw_f9-5tc5uiKG-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-12" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;span style=&quot;color: #871094&quot;&gt;（1）查询是否存在未执行抽奖的已领取的活动单：&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;this&lt;span style=&quot;font-family: &amp;#34;jetbrains mono&amp;#34; , monospace ; font-size: 15pt&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;font style=&quot;font-size: 12px&quot;&gt;queryNoConsumedTakeActivityOrder(&lt;/font&gt;&lt;/span&gt;req.getActivityId(), req.getuId());&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1070" y="160" width="450" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-17" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#000000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-13" target="kdpg4Kdw_f9-5tc5uiKG-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="1-r7k3Xzy-9-w0tIUs1n-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-13" target="1-r7k3Xzy-9-w0tIUs1n-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-13" value="存在？" style="rhombus;whiteSpace=wrap;html=1;fontSize=12;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1255" y="240" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-66" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#FF0000;strokeWidth=1;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-16" target="kdpg4Kdw_f9-5tc5uiKG-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-16" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;span style=&quot;color: #871094&quot;&gt;（2）查询已领取的活动单(从`user_take_activity`)：&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;super.queryActivityBill(req);&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1070" y="310" width="450" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-18" value="no" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=12;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1300" y="280" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-28" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#FF0000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-20" target="kdpg4Kdw_f9-5tc5uiKG-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-20" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;span style=&quot;color: #871094&quot;&gt;（2）校验该活动是否符合标准（时间，该用户抽取次数，状态，活动库存）：&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;b&gt;bill&lt;/b&gt;&lt;span style=&quot;color: rgb(8 , 8 , 8)&quot;&gt; = this.checkActivityBill(req, activityBillVO);&lt;/span&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1070" y="400" width="450" height="50" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-21" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;span style=&quot;background-color: #edfced&quot;&gt;SELECT activity_id, take_id, strategy_id, state&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;background-color: #edfced&quot;&gt;FROM user_take_activity&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;background-color: #edfced&quot;&gt;WHERE u_id = #{uId} AND activity_id = #{activityId} AND state = 0&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;background-color: #edfced&quot;&gt;ORDER BY id DESC&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;background-color: #edfced&quot;&gt;LIMIT 1&lt;/span&gt;&lt;/pre&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fontSize=12;fontColor=#000000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1540" y="140" width="400" height="100" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-41" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#000000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-27" target="kdpg4Kdw_f9-5tc5uiKG-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-27" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（3）扣减活动库存，通过Redis 活动库存扣减编号，作为锁的Key，缩小颗粒度：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;this.subtractionActivityStockByRedis(req.getuId(), &lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;req.getActivityId(), activityBillVO.getStockCount());&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1070" y="480" width="450" height="100" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-29" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;fontSize=12;fontColor=#FF0000;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1500" y="509.66" as="sourcePoint" />
            <mxPoint x="1570" y="509.66" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-32" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#FF0000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-30" target="kdpg4Kdw_f9-5tc5uiKG-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-30" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（1）获取抽奖活动库存 Key：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;Constants.RedisKey.KEY_LOTTERY_ACTIVITY_STOCK_COUNT(activityId);&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="480" width="450" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-34" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#FF0000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-31" target="kdpg4Kdw_f9-5tc5uiKG-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-31" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（2）扣减库存，目前占用库存数：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;Integer stockUsedCount = (int) redisUtil.incr(stockKey, 1);&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="570" width="450" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-37" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#FF0000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-33" target="kdpg4Kdw_f9-5tc5uiKG-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-33" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（3）超出库存判断，进行恢复原始库存：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;if (stockUsedCount &amp;gt; stockCount) {&lt;br&gt;            redisUtil.decr(stockKey, 1);&lt;br&gt;            return new StockResult(……);&lt;br&gt;        }&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="660" width="450" height="100" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-39" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#000000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-36" target="kdpg4Kdw_f9-5tc5uiKG-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-36" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（4）以活动库存占用编号，生成对应加锁Key，细化锁的颗粒度：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;String stockTokenKey = &lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;Constants.RedisKey.&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span&gt; &lt;/span&gt;KEY_LOTTERY_ACTIVITY_STOCK_COUNT_TOKEN(activityId, stockUsedCount)&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="790" width="450" height="100" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-38" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（5）使用 Redis.setNx 加一个分布式锁：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;boolean lockToken = redisUtil.setNx(stockTokenKey, 350L);&lt;/font&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;if (!lockToken) {&lt;br/&gt;    logger.info(&quot;抽奖活动用户秒杀扣减库存，分布式锁失败：{}&quot;);&lt;br/&gt;    return new StockResult();&lt;br/&gt;}&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="920" width="450" height="120" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-56" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;fontColor=#000000;strokeWidth=4;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-40" target="kdpg4Kdw_f9-5tc5uiKG-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-68" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#000000;strokeWidth=1;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-40" target="kdpg4Kdw_f9-5tc5uiKG-67" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-40" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（4）插入领取活动信息【个人用户把活动信息写入到用户表】：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;Long takeId = idGeneratorMap.get(Constants.Ids.SnowFlake).nextId();&lt;br&gt;Result grabResult = this.grabActivity(req, activityBillVO, takeId);&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1070" y="610" width="450" height="100" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-43" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;font style=&quot;font-size: 15px&quot;&gt;&lt;b&gt;subtractionActivityStockByRedis&lt;/b&gt;&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1665" y="440" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-45" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1560" y="1120" width="510" height="470" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-46" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#FF0000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-47" target="kdpg4Kdw_f9-5tc5uiKG-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-47" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（1）先分库分表：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;dbRouter.doRouter(partake.getuId());&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="1170" width="450" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-48" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#FF0000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-49" target="kdpg4Kdw_f9-5tc5uiKG-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-49" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（2）开启编程式事务：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;transactionTemplate.execute(status -&amp;gt; {&lt;/font&gt;（2.1）开始都在事务块里&lt;font color=&quot;#000000&quot;&gt;}&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="1260" width="450" height="60" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-50" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=12;fontColor=#FF0000;" parent="1" source="kdpg4Kdw_f9-5tc5uiKG-51" target="kdpg4Kdw_f9-5tc5uiKG-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-51" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px;&quot;&gt;&lt;font color=&quot;#871094&quot;&gt;（2.1）扣减个人已参与次数（&lt;/font&gt;操作`user_take_activity_count`&lt;font color=&quot;#871094&quot;&gt;）：&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;int updateCount = userTakeActivityRepository.subtractionLeftCount&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;font color=&quot;#080808&quot;&gt;(……, &lt;/font&gt;&lt;b&gt;bill.getTakeCount()&lt;/b&gt;&lt;font color=&quot;#080808&quot;&gt;, bill.getUserTakeLeftCount(), ……);&lt;br&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="1350" width="450" height="100" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-53" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;&lt;font color=&quot;#871094&quot;&gt;（2.2）&lt;/font&gt;&lt;b&gt;写入领取活动记录（操作`user_take_activity`）&lt;/b&gt;&lt;font color=&quot;#871094&quot;&gt;：&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;userTakeActivityRepository.takeActivity(……);&lt;/font&gt;&lt;br&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1570" y="1480" width="450" height="100" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-55" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 15px&quot;&gt;&lt;b&gt;grabActivity&lt;/b&gt;&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1665" y="1130" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-57" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;fontSize=12;fontColor=#FF0000;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2010" y="1399.66" as="sourcePoint" />
            <mxPoint x="2080" y="1399.66" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-62" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace ; font-size: 12px&quot;&gt;&lt;span style=&quot;color: rgb(8 , 8 , 8)&quot;&gt;&lt;span style=&quot;color: #0033b3&quot;&gt;public int &lt;/span&gt;&lt;span style=&quot;color: #00627a&quot;&gt;subtractionLeftCount&lt;/span&gt;(&lt;/span&gt;&lt;font color=&quot;#000000&quot;&gt;……&lt;/font&gt;&lt;font color=&quot;#080808&quot;&gt;, &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0)&quot;&gt;Integer &lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;takeCount, &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0)&quot;&gt;Integer &lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;userTakeLeftCount, &lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;……&lt;/font&gt;&lt;font color=&quot;#080808&quot;&gt;) {&lt;br&gt;    &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 51 , 179)&quot;&gt;if &lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;(&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 51 , 179)&quot;&gt;null &lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;== userTakeLeftCount) {&lt;/font&gt;&lt;font color=&quot;#080808&quot;&gt;&lt;br&gt;        &lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;……&lt;/font&gt;&lt;font color=&quot;#080808&quot;&gt;&lt;br&gt;        &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0)&quot;&gt;userTakeActivityCount&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;.setTotalCount(takeCount);&lt;br&gt;        &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0)&quot;&gt;userTakeActivityCount&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;.setLeftCount(takeCount - &lt;/font&gt;&lt;span style=&quot;color: rgb(23 , 80 , 235)&quot;&gt;1&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;);&lt;br&gt;        &lt;/font&gt;&lt;span style=&quot;color: rgb(135 , 16 , 148)&quot;&gt;userTakeActivityCountDao&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;.insert(&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0)&quot;&gt;userTakeActivityCount&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;);&lt;br&gt;        &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 51 , 179)&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;color: rgb(23 , 80 , 235)&quot;&gt;1&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;;&lt;br&gt;    } &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 51 , 179)&quot;&gt;else &lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;{&lt;/font&gt;&lt;font color=&quot;#080808&quot;&gt;&lt;br&gt;        &lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;……&lt;/font&gt;&lt;font color=&quot;#080808&quot;&gt;&lt;br&gt;        &lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 51 , 179)&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;color: rgb(135 , 16 , 148)&quot;&gt;userTakeActivityCountDao&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;.updateLeftCount(&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 0 , 0)&quot;&gt;userTakeActivityCount&lt;/span&gt;&lt;font color=&quot;#080808&quot;&gt;);&lt;br&gt;    }&lt;br&gt;}&lt;/font&gt;&lt;/pre&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fontSize=15;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="2080" y="1305" width="580" height="190" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-63" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;    @Override&lt;br&gt;    public void takeActivity(……) {&lt;br&gt;        ……&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;//这里的&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;b style=&quot;font-size: 12px ; font-family: &amp;quot;jetbrains mono&amp;quot; , monospace&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;userTakeLeftCount是先去用户领取活动表中查uid和活动id&lt;/font&gt;&lt;/b&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;b&gt;&lt;font color=&quot;#000000&quot;&gt;//然后去用户领取记录表中查对应的totalCount和leftCount&lt;/font&gt;&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;b&gt;&lt;font color=&quot;#000000&quot;&gt;//终于搞明白`user_take_activity`中take_count字段的意思了&lt;/font&gt;&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;b&gt;&lt;font color=&quot;#000000&quot;&gt;//它指的是该活动已经被领取的次数&lt;/font&gt;&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;b&gt;        if (null == userTakeLeftCount) {&lt;br&gt;            userTakeActivity.setTakeCount(1);&lt;br&gt;        } else {&lt;br&gt;            userTakeActivity.setTakeCount(takeCount - userTakeLeftCount + 1);&lt;br&gt;        }&lt;/b&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;        userTakeActivity.setStrategyId(strategyId);&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;b&gt;//设置活动领取的状态为未使用&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;        userTakeActivity.setState(Constants.TaskState.NO_USED.getCode());&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;b&gt;//防重Id&lt;/b&gt;&lt;br&gt;        String uuid = uId + &quot;_&quot; + activityId + &quot;_&quot; + userTakeActivity.getTakeCount();&lt;br&gt;        userTakeActivity.setUuid(uuid);&lt;br&gt;&lt;br&gt;        userTakeActivityDao.insert(userTakeActivity);&lt;br&gt;    }&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;font face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 12px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fontSize=15;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="2080" y="1510" width="580" height="450" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-64" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;fontSize=12;fontColor=#FF0000;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2009.9999999999995" y="1540" as="sourcePoint" />
            <mxPoint x="2079.9999999999995" y="1540" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-67" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font&gt;&lt;font color=&quot;#871094&quot; face=&quot;jetbrains mono, monospace&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;（5）扣减活动库存，通过Redis End：&lt;/span&gt;&lt;/font&gt;&lt;/font&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;this.recoverActivityCacheStockByRedis(req.getActivityId(), &lt;/font&gt;&lt;/pre&gt;&lt;blockquote style=&quot;margin: 0 0 0 40px ; border: none ; padding: 0px&quot;&gt;&lt;blockquote style=&quot;margin: 0 0 0 40px ; border: none ; padding: 0px&quot;&gt;&lt;blockquote style=&quot;margin: 0 0 0 40px ; border: none ; padding: 0px&quot;&gt;&lt;blockquote style=&quot;margin: 0 0 0 40px ; border: none ; padding: 0px&quot;&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;subtractionActivityResult.getStockKey(), &lt;/font&gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;blockquote style=&quot;margin: 0 0 0 40px ; border: none ; padding: 0px&quot;&gt;&lt;blockquote style=&quot;margin: 0 0 0 40px ; border: none ; padding: 0px&quot;&gt;&lt;blockquote style=&quot;margin: 0 0 0 40px ; border: none ; padding: 0px&quot;&gt;&lt;pre style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;&lt;font color=&quot;#080808&quot; face=&quot;jetbrains mono, monospace&quot;&gt;Constants.ResponseCode.SUCCESS.getCode());&lt;/font&gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=12;fontColor=#FF0000;align=left;" parent="1" vertex="1">
          <mxGeometry x="1070" y="750" width="450" height="110" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-69" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; color: rgb(8 , 8 , 8) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;span style=&quot;color: #9e880d&quot;&gt;@Override&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #0033b3&quot;&gt;public void &lt;/span&gt;&lt;span style=&quot;color: #00627a&quot;&gt;recoverActivityCacheStockByRedis&lt;/span&gt;(&lt;span style=&quot;color: #000000&quot;&gt;Long &lt;/span&gt;activityId, &lt;span style=&quot;color: #000000&quot;&gt;String &lt;/span&gt;tokenKey, &lt;span style=&quot;color: #000000&quot;&gt;String &lt;/span&gt;code) {&lt;br&gt;    &lt;span style=&quot;color: #6f8683 ; font-style: italic&quot;&gt;// &lt;/span&gt;&lt;span style=&quot;color: #6f8683 ; font-style: italic ; font-family: &amp;#34;宋体&amp;#34; , monospace&quot;&gt;删除分布式锁&lt;/span&gt;&lt;span style=&quot;color: #6f8683 ; font-style: italic&quot;&gt; Key&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #6f8683 ; font-style: italic&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #871094&quot;&gt;redisUtil&lt;/span&gt;.del(tokenKey);&lt;br&gt;}&lt;/pre&gt;" style="text;whiteSpace=wrap;html=1;fontSize=12;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="966" y="870" width="550" height="130" as="geometry" />
        </mxCell>
        <mxCell id="kdpg4Kdw_f9-5tc5uiKG-71" value="&lt;pre style=&quot;background-color: rgb(255 , 255 , 255) ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace&quot;&gt;&lt;font style=&quot;font-size: 15px&quot;&gt;&lt;b&gt;doPark()&lt;/b&gt;&lt;/font&gt;&lt;/pre&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1160" y="120" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="1-r7k3Xzy-9-w0tIUs1n-2" value="返回&quot;&lt;font style=&quot;font-size: 12px;&quot;&gt;&lt;span style=&quot;color: rgb(6, 125, 23); background-color: rgb(245, 234, 193); font-family: 宋体, monospace;&quot;&gt;未消费活动领取记录&lt;/span&gt;&lt;span style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; color: rgb(6, 125, 23); background-color: rgb(245, 234, 193);&quot;&gt;&quot;&lt;/span&gt;&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1390" y="230" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="1-r7k3Xzy-9-w0tIUs1n-4" value="yes" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=12;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1335" y="235" width="40" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
